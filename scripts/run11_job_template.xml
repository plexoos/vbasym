<?xml version="1.0" encoding="utf-8" ?>
<job filesPerHour="150" maxFilesPerProcess="500" fileListSyntax="xrootd" inputOrder="runnumber" simulateSubmission="false" name="&RUN_ID;">
   <ResourceUsage>
      <StorageSpace>
         <MinStorage>20</MinStorage>
      </StorageSpace>
   </ResourceUsage>

   <Generator>
      <Location>./sums/</Location>
   </Generator>

   <command>
      starver &STAR_VER;

      cp $FILELIST &OUT_DIR;/lists/R&RUN_ID;.lis

      setenv RUNLIST  &OUT_DIR;/lists/R&RUN_ID;.lis
      setenv OPTIONS  `echo &STANA_OPTIONS; | sed 's/_/ /g'`
      setenv OPT_JETS `echo $OPTIONS | awk '{print index($0,"--jets")}'`
      setenv COMMAND  "./stana -f $RUNLIST $OPTIONS"

      if ($OPT_JETS == 0) ln -s &OUT_DIR;_--jets/jets/R&RUN_ID;_jets.root
      cp -r &CODE_DIR;/.sl53_gcc432 .
      cp -r &CODE_DIR;/stana .
      ls -al

      echo
      echo "OUT_DIR:        " &OUT_DIR;
      echo "CODE_DIR:       " &CODE_DIR;
      echo "RUN_ID:         " &RUN_ID;
      echo "STAR_VER:       " &STAR_VER;
      echo "STANA_OPTIONS:  " &STANA_OPTIONS;
      echo
      echo "STAR:           " $STAR
      echo "FILELIST:       " $FILELIST
      echo "RUNLIST:        " $RUNLIST
      echo "OPTIONS:        " $OPTIONS
      echo "OPT_JETS:       " $OPT_JETS
      echo "SCRATCH:        " $SCRATCH
      echo "pwd:            " `pwd`
      echo "COMMAND:        " $COMMAND
      echo

      `$COMMAND`

      # Remove files and links
      if ($OPT_JETS == 0) rm R&RUN_ID;_jets.root
      chmod 664 *_hist.root *_jets.root *_tree.root *.ps *.txt
      chmod 664 &OUT_DIR;/log/R&RUN_ID;.log
      touch     &OUT_DIR;/log/R&RUN_ID;.log
      rm -fr ./.sl53_gcc432
      rm -fr ./stana

      echo "End of stana: tralala"

   </command>

   <output fromScratch="*_jets.root" toURL="file:&OUT_DIR;/jets/"/>
   <output fromScratch="*_hist.root" toURL="file:&OUT_DIR;/hist/"/>
   <output fromScratch="*_tree.root" toURL="file:&OUT_DIR;/tree/"/>
   <output fromScratch="*.txt"       toURL="file:&OUT_DIR;/lumi/"/>
   <stdout URL="file:&OUT_DIR;/log/R&RUN_ID;.log"/>
   <stderr URL="file:&OUT_DIR;/log/R&RUN_ID;.log"/>

   <SandBox>
       <Package>
          <File>file:&CODE_DIR;/.sl53_gcc432</File>
       </Package>
   </SandBox>

   <input URL="catalog:star.bnl.gov?filename~st_W,production=P11id,filetype=daq_reco_mudst,storage=hpss,runnumber~&RUN_ID;%" nFiles="all" />
   <!--<input URL="catalog:star.bnl.gov?filename~st_W,library=SL11id,filetype=daq_reco_mudst,storage=nfs,runnumber=&RUN_ID;" nFiles="all" />-->
   <!--<input URL="catalog:star.bnl.gov?filename~st_W,production=P09ig,filetype=daq_reco_mudst,runnumber=&RUN_ID;" nFiles="all" />-->
</job>
